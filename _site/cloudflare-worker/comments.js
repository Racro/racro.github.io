async function handleRequest(e){const t=new URL(e.url),n={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};if("OPTIONS"===e.method)return new Response(null,{headers:n});if("GET"===e.method){const e=t.searchParams.get("page"),s=t.searchParams.get("type");if(!e)return new Response(JSON.stringify({error:"Missing page parameter"}),{status:400,headers:{...n,"Content-Type":"application/json"}});try{if("reactions"===s){const t=`reactions:${e}`,s=await COMMENTS_KV.get(t,"json")||{likes:0,loved:0,total:0};return new Response(JSON.stringify(s),{headers:{...n,"Content-Type":"application/json"}})}{const t=await COMMENTS_KV.get(e,"json")||[];return new Response(JSON.stringify(t),{headers:{...n,"Content-Type":"application/json"}})}}catch(e){return new Response(JSON.stringify({error:"Failed to fetch data"}),{status:500,headers:{...n,"Content-Type":"application/json"}})}}if("POST"===e.method){let t;try{t=await e.json()}catch(e){return new Response(JSON.stringify({error:"Invalid JSON in request body"}),{status:400,headers:{...n,"Content-Type":"application/json"}})}const{type:s}=t;if("reaction"===s)try{const{page:s,reaction:a}=t;if(!s||!a)return new Response(JSON.stringify({error:"Page and reaction type required"}),{status:400,headers:{...n,"Content-Type":"application/json"}});if(!["like","loved"].includes(a))return new Response(JSON.stringify({error:"Invalid reaction type"}),{status:400,headers:{...n,"Content-Type":"application/json"}});const o=e.headers.get("CF-Connecting-IP")||"unknown",r=`user_reaction:${s}:${t.fingerprint||o.substring(0,10)}`,i=await COMMENTS_KV.get(r);if(i&&i===a)return new Response(JSON.stringify({error:"You already reacted with this",alreadyReacted:!0}),{status:400,headers:{...n,"Content-Type":"application/json"}});const p=`reactions:${s}`,c=await COMMENTS_KV.get(p,"json")||{likes:0,loved:0,total:0};return i&&i!==a&&("like"===i&&(c.likes=Math.max(0,c.likes-1)),"loved"===i&&(c.loved=Math.max(0,c.loved-1)),c.total=Math.max(0,c.total-1)),"like"===a&&c.likes++,"loved"===a&&c.loved++,c.total=c.likes+c.loved,await COMMENTS_KV.put(p,JSON.stringify(c)),await COMMENTS_KV.put(r,a,{expirationTtl:31536e3}),new Response(JSON.stringify({success:!0,reactions:c}),{headers:{...n,"Content-Type":"application/json"}})}catch(e){return new Response(JSON.stringify({error:"Failed to save reaction"}),{status:500,headers:{...n,"Content-Type":"application/json"}})}try{const{page:s,name:a,email:o,comment:r}=t;if(!s||!r||0===r.trim().length)return new Response(JSON.stringify({error:"Page and comment are required"}),{status:400,headers:{...n,"Content-Type":"application/json"}});if(r.trim().length<3)return new Response(JSON.stringify({error:"Comment too short"}),{status:400,headers:{...n,"Content-Type":"application/json"}});const i=e.headers.get("CF-Connecting-IP")||"unknown",p=`rate_limit:${i}:${s}`,c=await COMMENTS_KV.get(p);if(c){const e=parseInt(c);if(Date.now()-e<1e4)return new Response(JSON.stringify({error:"Please wait 10 seconds before commenting again"}),{status:429,headers:{...n,"Content-Type":"application/json"}})}const l={id:Date.now().toString()+Math.random().toString(36).substr(2,9),page:s,name:a||"Anonymous",email:o||"",comment:r.trim(),timestamp:(new Date).toISOString(),ip:i.substring(0,7)+"..."},d=[...await COMMENTS_KV.get(s,"json")||[],l];try{await COMMENTS_KV.put(s,JSON.stringify(d))}catch(e){throw new Error(`Failed to save comment to KV: ${e.message}`)}try{await COMMENTS_KV.put(p,Date.now().toString(),{expirationTtl:10})}catch(e){}return new Response(JSON.stringify({success:!0,comment:l}),{status:200,headers:{...n,"Content-Type":"application/json"}})}catch(e){return new Response(JSON.stringify({error:"Failed to save comment",details:e.message}),{status:500,headers:{...n,"Content-Type":"application/json"}})}}return new Response("Method not allowed",{status:405,headers:n})}addEventListener("fetch",(e=>{e.respondWith(handleRequest(e.request))}));